"use strict";(self.webpackChunkdevsecblueprint=self.webpackChunkdevsecblueprint||[]).push([[2652],{1530:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/service-account-creation-74eca7e4e1831f9b627d7300d3ed7d2c.png"},1925:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"projects/devsecops-pipeline-gcp/setup/configuring-deployment-user-gcp","title":"Configuring Deployment Service Account in GCP","description":"Overview","source":"@site/docs/projects/devsecops-pipeline-gcp/setup/creating-deployment-sa.md","sourceDirName":"projects/devsecops-pipeline-gcp/setup","slug":"/projects/devsecops-pipeline-gcp/setup/configuring-deployment-user-gcp","permalink":"/vi/projects/devsecops-pipeline-gcp/setup/configuring-deployment-user-gcp","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"id":"configuring-deployment-user-gcp","title":"Configuring Deployment Service Account in GCP","sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Setting Up Terraform Cloud","permalink":"/vi/projects/devsecops-pipeline-gcp/setup/setup-terraform-cloud"},"next":{"title":"Configuring Secrets and Environment Variables","permalink":"/vi/projects/devsecops-pipeline-gcp/setup/config-secrets-gcp"}}');var s=r(4848),t=r(8453);const c={id:"configuring-deployment-user-gcp",title:"Configuring Deployment Service Account in GCP",sidebar_position:4},o=void 0,l={},d=[{value:"Overview",id:"overview",level:2},{value:"Step 1: Create and Configure the Service Account",id:"step-1-create-and-configure-the-service-account",level:2},{value:"Step 2: Configure Workload Identity Federation",id:"step-2-configure-workload-identity-federation",level:2},{value:"Step 3: Grant Access via Impersonation",id:"step-3-grant-access-via-impersonation",level:2}];function a(e){const n={blockquote:"blockquote",br:"br",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:["This guide walks you through setting up a Google Cloud Platform (GCP) Service Account for ",(0,s.jsx)(n.strong,{children:"Terraform Cloud"})," deployments using ",(0,s.jsx)(n.strong,{children:"OIDC (OpenID Connect)"})," via ",(0,s.jsx)(n.strong,{children:"Workload Identity Federation (WIF)"}),". This setup allows Terraform Cloud to securely authenticate to GCP without relying on long-lived service account keys, ultimately enabling short-lived, scoped credentials per workspace."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["\u2705 ",(0,s.jsx)(n.strong,{children:"Before you begin:"})," Ensure you have a GCP project available and sufficient permissions to create service accounts and manage IAM."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"step-1-create-and-configure-the-service-account",children:"Step 1: Create and Configure the Service Account"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Log in to your GCP account."})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["In the left-hand menu, go to:",(0,s.jsx)(n.br,{}),"\n",(0,s.jsx)(n.strong,{children:"IAM & Admin"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Service Accounts"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Click ",(0,s.jsx)(n.strong,{children:"Create Service Account"}),", and fill in:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Name"}),": ",(0,s.jsx)(n.code,{children:"terraform-deployer"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Description"}),": (optional)"]}),"\n",(0,s.jsxs)(n.li,{children:["Click ",(0,s.jsx)(n.strong,{children:"Create and Continue"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Service Account Creation Screenshot",src:r(1530).A+"",width:"2572",height:"564"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Grant the following roles"})," to the service account:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Editor"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Project IAM Admin"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Role Administrator"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Secret Manager Admin"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"Secret Manager Secret Accessor"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"IAM Service Account Token Creator"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Under ",(0,s.jsx)(n.strong,{children:"Grant users access to this service account"}),", leave it blank and click ",(0,s.jsx)(n.strong,{children:"Done"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"step-2-configure-workload-identity-federation",children:"Step 2: Configure Workload Identity Federation"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["In the GCP Console, go to ",(0,s.jsx)(n.strong,{children:"IAM & Admin"})," \u2192 ",(0,s.jsx)(n.strong,{children:"Workload Identity Federation"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Click ",(0,s.jsx)(n.strong,{children:"Create Pool"})," and enter the following:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Pool Name"}),": ",(0,s.jsx)(n.code,{children:"Terraform Cloud"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Pool ID"}),": ",(0,s.jsx)(n.code,{children:"terraform-cloud"})]}),"\n",(0,s.jsxs)(n.li,{children:["\u2705 Check the box: ",(0,s.jsx)(n.strong,{children:"Enabled Provider"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"In the same flow, add a new provider:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Provider Type"}),": ",(0,s.jsx)(n.code,{children:"OIDC"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Provider Name"}),": ",(0,s.jsx)(n.code,{children:"default"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Issuer URL"}),": ",(0,s.jsx)(n.code,{children:"https://app.terraform.io"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Audiences"}),": Select ",(0,s.jsx)(n.code,{children:"Default Audience"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Configure Attribute Mappings"}),":"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Google Attribute"}),(0,s.jsx)(n.th,{children:"OIDC Assertion"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"attribute.terraform_full_workspace"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"assertion.terraform_full_workspace"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"google.sub"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"assertion.sub"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"attribute.terraform_workspace"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"assertion.terraform_workspace_id"})})]})]})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Add Attribute Condition"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hcl",children:'assertion.terraform_organization_name == "DSB"\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Click ",(0,s.jsx)(n.strong,{children:"Create"})," to finalize the pool and provider."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"step-3-grant-access-via-impersonation",children:"Step 3: Grant Access via Impersonation"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["After the pool and provider are created, click ",(0,s.jsx)(n.strong,{children:"Grant Access"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Choose ",(0,s.jsx)(n.strong,{children:"Grant access using service account impersonation"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Select the previously created service account (",(0,s.jsx)(n.code,{children:"terraform-deployer"}),")."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Add the ",(0,s.jsx)(n.strong,{children:"Terraform Workspace Principal"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Use your workspace ID to define the principal."}),"\n",(0,s.jsx)(n.li,{children:"Example format:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"principalSet://iam.googleapis.com/projects/<project-number>/locations/global/workloadIdentityPools/terraform-cloud/attribute.terraform_workspace_id/<workspace-id>\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Service Account Grant Screenshot",src:r(6743).A+"",width:"1220",height:"1726"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["With this setup complete, Terraform Cloud will now be able to authenticate to GCP using OIDC and impersonate the ",(0,s.jsx)(n.code,{children:"terraform-deployer"})," service account during runs \u2014 ",(0,s.jsx)(n.strong,{children:"without the need for storing or rotating service account keys"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"You can now move on to configuring your Terraform provider and environment variables."})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},6743:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/grant-sa-permissions-oidc-78b3322e8c1544e181beb9f2c3b7615e.png"},8453:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>o});var i=r(6540);const s={},t=i.createContext(s);function c(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);